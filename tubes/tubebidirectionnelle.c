#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>

#define NUMBERS_TO_SEND 5


void fils(int p_f[2], int f_p[2]){

    close(p_f[1]);// comme le fils lit le tube venant du père alors il faut fermet celui ci en ecriture
    close(f_p[0]);// comme le fils ecris dans son tube il faut le fermet en lectures
    int received_number;
    for(int i=0;i<NUMBERS_TO_SEND;i++){
        read(p_f[0],&received_number,sizeof(int));
        printf("fils a recu %d\n", received_number);
        received_number*=2;
        write(f_p[1],&received_number,sizeof(int));
        printf("fils a envoyé %d\n",received_number);
      
    }
    close(p_f[0]);
    close(f_p[1]);
    printf("Terminaison du fils avec success\n");
    exit(EXIT_SUCCESS);
}

int main(){

    pid_t pid_fils;
    int p_f[2],f_p[2];

    if((pipe(p_f)==-1)||(pipe(f_p)==-1)){
        perror("Erreur lors de la création des tubes");
        exit(EXIT_FAILURE);
    }

    pid_fils = fork();

    if (pid_fils == -1) {
        perror("Erreur lors de la création du processus fils");
        exit(EXIT_FAILURE);
    }

    if (pid_fils == 0) {
        fils(p_f,f_p);
    } else {
        close(p_f[0]);
        close(f_p[1]);
        
         int numbers[NUMBERS_TO_SEND] = {1, 2, 3, 4, 5};
         int received_number;
        for(int i=0;i<NUMBERS_TO_SEND;i++){

            write(p_f[1],&numbers[i],sizeof(int));
            printf("pere a envoyé %d\n", numbers[i]);

            read(f_p[0],&received_number,sizeof(int));
            printf("père a recu %d\n", received_number);
           
        }
        close(p_f[1]);
        close(f_p[0]);

        wait(NULL);
        printf("Père : Termination du processus père\n");

    }
    



    return 0;
}